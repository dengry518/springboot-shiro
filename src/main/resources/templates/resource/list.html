<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script th:src="@{/miniui/boot.js}" type="text/javascript"></script>
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            border: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
<div class="mini-splitter" style="width:100%;height:100%;">
    <div size="240" showCollapseButton="true">
        <div class="mini-fit" style="margin-top: 5px;margin-left: 5px">
            <ul id="tree1" class="mini-tree" url="/node/findLeftTree" style="width:100%;"
                showTreeIcon="true" textField="text" idField="id" parentField="pid" resultAsTree="false"

            >
            </ul>
        </div>
    </div>
    <div showCollapseButton="true">
        <div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
            <a class="mini-button" iconCls="icon-add" plain="true" onclick="add()">新增</a>
            <span class="separator"></span>
            <a class="mini-button" iconCls="icon-remove" plain="true" onclick="remove()">删除</a>
            <span class="separator"></span>
            <a class="mini-button" iconCls="icon-edit" plain="true" onclick="edit()">编辑</a>
        </div>
        <div class="mini-fit">
            <div id="grid1" class="mini-datagrid" style="width:100%;height:100%;"
                 borderStyle="border:0;"
                 url="/resource/findResByNode"
            >
                <div property="columns">
                    <div field="name" width="120" headerAlign="center" allowSort="true">资源名称
                    </div>

                    <div field="url" width="100" allowSort="true" align="center"
                         headerAlign="center">url
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    mini.parse();
    var tree = mini.get("tree1");
    tree.expandAll();
    var grid = mini.get("grid1");

    var nodeId = '';
    tree.on("nodeselect", function (e) {
        if (e.isLeaf) {
            console.log(e.node.id);
            nodeId = e.node.id;
            grid.load({'nodeId': nodeId});
        } else {
            grid.setData([]);
            grid.setTotalCount(0);
        }
    });

    function add() {
        mini.open({
            url: "/resource/toAdd",
            title: "新增资源",
            width: 350,
            height: 250,
            onload: function () {
                var iframe = this.getIFrameEl();
                var data = {action: "new", 'nodeId': nodeId};
                iframe.contentWindow.SetData(data);
            },
            ondestroy: function (action) {
                grid.reload();
            }
        });
    }

    function edit() {
        var row = grid.getSelected();
        if (row) {
            mini.open({
                url: "/resource/toAdd",
                title: "修改资源",
                width: 350,
                height: 250,
                onload: function () {
                    var iframe = this.getIFrameEl();
                    var data = {
                        action: "edit",
                        'nodeId': nodeId,
                        "id": row.id,
                        url: row.url,
                        name: row.name,
                        description: row.description
                    };
                    iframe.contentWindow.SetData(data);
                },
                ondestroy: function (action) {
                    grid.reload();
                }
            });
        } else {
            mini.alert("请选中一条记录");
        }
    }

    function remove() {
        var row = grid.getSelected();
        if (row) {
            mini.confirm("确定删除选中记录？", "确定？",
                function (action) {
                    if (action == "ok") {
                        $.ajax({
                            url: "/resource/delById",
                            data: {"id": row.id},
                            success: function (data) {
                                if (data.succ) {
                                    grid.reload();
                                }
                            }
                        });
                    }
                }
            );
        } else {
            mini.alert("请选中一条记录");
        }
    }


</script>
</body>
</html>